{% extends 'base.html' %}
{% load bootstrap %}
{% block title %} | Facilitation{% endblock %}
{% block content %}
{% load part_string %}

{% comment %}
    <script type="text/javascript" src="{{STATIC_URL}}js/bootstrap-multiselect.js"></script>
    <link rel="stylesheet" href="{{STATIC_URL}}css/bootstrap-multiselect.css" type="text/css"/>
{% endcomment %}

<script>
    window.hierarchy_name = '{{section.hierarchy.name}}';
    window.username = '{{request.user.username}}';
    window.freshTokenUrl = '/facilitator/fresh_token/';
    window.token = '{{token}}';
    window.websocketsBase = '{{websockets_base}}';
</script>
<script type="text/javascript" src="{{STATIC_URL}}js/uelc_admin/web_socks.js"></script>

<div id="content" class="container-fluid">
    <h1>Case Control for {{case.name}}</h1>
    <p>Use the control panel to check group progress as well as lock and unlock.</p>

    {% for u in user_sections %}
      {% if u.0.profile.profile_type == "group_user" %}
      <div class="col-sm-3 text-center">
      <!-- user (u.0), gateblocks (u.1), (u.2) user_last_location -->
          <div class="gate-sections" id="group-user-section-{{u.0.id}}">


            <div class="group-name panel panel-default">
                <div class="panel-body">
                    <h3 class="text-center">
                        <h3 class="facilitator-usrnm">Group {{u.0}}</h3> 
                    </h3>
                </div>
            </div>

            <div class="text-center">
                <span class="glyphicon glyphicon-triangle-bottom" aria-hidden="true"></span>
            </div>

        

            <div class="gate-section-list well well-sm">
            {% for sec in u.1 %}

                {% comment %}
                <!--
                    section (sec.0), gateblock (sec.1), unlocked (sec.2),
                    user (sec.3), status (sec.4), can_show_gateblock (sec.5),
                    (sec.6) section part, (sec.7.0) is_curveball,
                    (sec.7.1) curveball block, (sec.8.0) is_decision_block,
                    (sec.8.1) decision block, (sec.9) is_next_curveball
                -->
                {% endcomment %}

                {% if sec.2 %}<!-- if unlocked -->
                    {% if sec.5 %}<!-- can show gateblock -->
                    <div class="group-btn-list gate-block part-{{sec.6.0|part}}" data-section-id="{{sec.0.pk}}" data-user-loc="{{ u.2.id }}" data-group-id="{{u.0.id}}">
                        {{ sec.9.0 }}
                        {% if sec.7.0 %}<!-- if curveball -->
                            {% include "pagetree/curveball.html" %}
                        {% endif %}

                        <div class="gate-section panel panel-default">

                            <div class="panel-heading">
                                <h3 class="panel-title text-center">{{ sec.1.pageblock.label }}</h3>
                            </div>

                            <div class="panel-body">
                                <div class="pull-left badge text-capitalize status {{sec.4}}">{{sec.4}}</div>
                                {% if sec.0.pk == u.2.id %}
                                    <div class="pull-right">
                                        <span class="glyphicon glyphicon-user" aria-hidden="true"></span>
                                    </div>
                                {% endif %}
                                {% if sec.8.0 and sec.8.2 %} <!-- if decision block and responded -->
                                <div class="response">
                                    <p>{{ sec.8.2.title }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div><!--end .gate-section-->

                      <div class="gate-button unlocked" data-part-dec-raw="{{sec.6.1}}" data-part-decision="{{sec.6.1|convert_part2}}">
                        <div class="btn-group-vertical" role="group" aria-label="..."  style="width: 100%;">
                          <div type="submit" class="btn-sm btn-success text-center status-{{sec.4}}" style="margin-top: 5px;">
                            <span><span class="glyphicon glyphicon-ok" aria-hidden="true"></span> {{ sec.1.pageblock.label }} </span>
                          </div>
                       </div>
                       <div class="clearfix visible-lg-block"></div>
                      </div><!-- end .gate-button-->

                    </div><!-- end .gate-block-->
                    {% endif %}

                {% else %}<!-- gateblock not unlocked-->

                  {% if sec.5 %} <!-- can show gateblock -->
                  <div class="group-btn-list gate-block part-{{sec.6.0|part}} {% if sec.4 == 'reviewing' or sec.4 == 'reviewed' %}active{% endif%}" data-section-id="{{sec.0.pk}}" data-user-loc="{{ u.2.id }}" data-group-id="{{u.0.id}}">
                  {{ sec.9.0 }}
                    {% if sec.7.0 %}<!-- if curveball -->
                        {% include "pagetree/curveball.html" %}
                    {% endif %}

                    <div class="gate-section panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title text-center">{{ sec.1.pageblock.label }}</h3>
                        </div>

                        <div class="panel-body">
                            <div class="badge pull-left text-capitalize status {{sec.4}}">{{sec.4}}</div>
                            {% if sec.0.pk == u.2.id %}
                                <div class="pull-right">
                                    <span class="glyphicon glyphicon-user" aria-hidden="true"></span>
                                </div>
                            {% endif %}
                            {% if sec.8.0 and sec.8.2 %} <!-- if decision block and responded -->
                                <div class="response">
                                    <p>{{ sec.8.2.title }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div><!--end .gate-section-->

                    <div class="gate-button locked {{sec.6.0|convert}}" data-part-dec-raw="{{sec.6.1}}" data-part-decision="{{sec.6.1|convert_part2}}">
                      <form action ="." method="post">{% csrf_token %}
                        <div class="btn-group-vertical" role="group" aria-label="..."  style="width: 100%;">
                          <div display="none" type="none" class="btn btn-sm btn-danger btn-block text-center" style="margin-top: 5px;">
                            <span><span class="glyphicon glyphicon-lock" aria-hidden="true"></span> {{ sec.1.pageblock.label }}</span>
                           </div>

                            </div>
                            <div class="clearfix visible-lg-block"></div>
                            <input type="hidden" name="gate-action" value="submit" />
                            <input type="hidden" name="user_type" value="{{u.0.profile.profile_type}}" />
                            <input type="hidden" name="user_id" value="{{u.0.id}}" />
                            <input type="hidden" name="section" value="{{sec.0.id}}" />
                            <input type="hidden" name="block" value="{{sec.1.id}}" />
                            <input type="hidden" class="post" value="{{sec.0.get_absolute_url}}">
                        </form>
                    </div><!-- end .gate-button-->


                </div><!-- end .gate-block -->
                    {% endif %}
                {% endif %}

            {% endfor %}
            </div><!--end gaet-section-list-->
        </div><!--end gate-sections -->
   </div><!-- end .col-sm-3 -->
   {% endif %}
    {% endfor %}

<br style="clear:both;"/>

</div><!--end .content -->
<script src="{{STATIC_URL}}js/uelc_admin/uelc_facilitator.js"></script>
{% endblock %}
