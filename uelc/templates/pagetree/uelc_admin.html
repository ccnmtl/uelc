{% extends 'pagetree/base_pagetree.html' %}
{% load bootstrap %}
{% block content %}
<script type="text/javascript" src="{{STATIC_URL}}js/bootstrap-multiselect.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.validate.min.js"></script>
<link rel="stylesheet" href="{{STATIC_URL}}css/bootstrap-multiselect.css" type="text/css"/>
<p>Welcome,</p>
<p>This page is for creating Users, Cases, and Cohorts</p>

<div id="hierarchies" class="panel panel-default">
  <div class="panel-heading">Hierarchies</div>
  <div class="panel-body">
    <form data-toggle="validator" id="add-hierarchy-form" action="." method="post">
      {{create_hierarchy_form|bootstrap}}
      <input type="hidden" name="action" value="hierarchyCallback">
      <input type="submit" class="btn btn-primary form-submit" value="Submit">
    </form>
  </div>
</div><!--end #hierarchiess-->

<div id="users" class="panel panel-default">
  <div class="panel-heading">Users</div>
  <div class="panel-body">
    <form role="form" data-toggle="validator" id="add-user-form" action="." method="post">
      {{ create_user_form|bootstrap }}
      <input type="hidden" name="action" value="createUserCallback">
      <input type="submit" class="btn btn-primary form-submit" value="Submit">
    </form>
  </div>
</div><!--end #users-->

<div id="cohorts" class="panel panel-default">
  <div class="panel-heading">Cohorts</div>
  <div class="panel-body">
  <form action="." method="post" >
    {{cohortmodel.add_form|bootstrap}}
  </form>
  </div>
</div><!--end #cohorts-->

<div id="cases" class="panel panel-default">
  <div class="panel-heading">Cases</div>
  <div class="panel-body">
  <form action="." method="post" >
    {{casemodel.add_form|bootstrap}}
  </form>
  </div>
</div><!--end #cases-->

<script>
jQuery(document).ready(function(){
  // create Admin class
  var UELCAdmin = function(){
    this.setMultiselects = function(){
      jQuery('.hierarchy-select').multiselect();
      jQuery('.cohort-select').multiselect();
      jQuery('.user-select').multiselect();
      jQuery('.create-user-profile').multiselect();
      
    },
    
    this.formUpdate = function(form){
      console.log(form);
    },

    this.highlight = function(element){
      jQuery(element).closest('.form-control').parent().removeClass('success').addClass('has-error');
    },

    this.removeHighlight = function(element){
      console.log(element);
      jQuery(element).addClass('valid').parent().removeClass('has-error').addClass('success');
    }

    this.submit = function(form){
      jQuery(form).validate({
        debug: true, 
          rules: {
              name: {
                  minlength: 2,
                  required: true
              },
              url: {
                  required: true,
              },
              username:{
                minlength: 2,
                required: true,
              },
              password1:{
                minlength: 3,
                required: true,
              },
              password2:{
                minlength: 3,
                required: true,
                equalTo : "#id_password1"
              }
          },
          highlight: function (element) {
              window.admin.highlight(element);
          },
          success: function (element) {
              window.admin.removeHighlight(element);
          },
          error: function(){
            alert('problem!')
          },
          submitHandler: function(form){
            jQuery.post( "/uelcadmin/", jQuery(form).serialize(), function(data){
              window.admin[data.action](data.action_args);
            });
          },
          invalidHandler: function(event, validator) {
            // 'this' refers to the form
            var errors = validator.numberOfInvalids();
            if (errors) {
              var message = errors == 1
                ? 'You missed 1 field. It has been highlighted'
                : 'You missed ' + errors + ' fields. They have been highlighted';
              $("div.error span").html(message);
              $("div.error").show();
            } else {
              $("div.error").hide();
            }
          }
        });//end validate
    },

    this.addListeners = function(){
      jQuery('.form-submit').click(function(){
        var form = jQuery(this).parent()
        window.admin.submit(form);
      })
    },

    this.hierarchyCallback = function(data){
      if(data.error){
        jQuery('#add-hierarchy-form').find('input.form-control').each(function(){
          window.admin.highlight(this);  
        })
        alert(data.error);
      }else{
        // success
        elem = jQuery('.hierarchy-select');
        html = '<option value='+data.value+'>'+data.name+'</option>';
        elem.append(html)
        jQuery('.hierarchy-select').multiselect('destroy').multiselect('refresh');
        jQuery('#add-hierarchy-form').trigger("reset");
        jQuery('#add-hierarchy-form').find('input.form-control').each(function(){
          window.admin.removeHighlight(this);  
        })
        alert('Your Hierarchy has been created! It is available for editing,\
          so go and add some content! You can access it here,'+data.url+'edit/');
      }
    },

    this.createUserCallback = function(data){
      if(data.error){

        jQuery('.create-user-profile').parent().parent().addClass('has-error')
        alert(data.error);
      }else{
        elem = jQuery('.user-select');
        html = '<option value='+data.user+'>'+data.username+'</option>';
        elem.append(html)
        jQuery('.user-select').multiselect('destroy').multiselect('refresh');
        jQuery('#add-user-form').trigger("reset");
        jQuery('.create-user-profile').multiselect('destroy').multiselect('refresh');
        jQuery('.create-user-profile').parent().parent().removeClass('has-error')
        jQuery('#add-user-form').find('input.form-control').each(function(){
          window.admin.removeHighlight(this);  
        })
        alert('created user');
        
      }
    },

    this.init = function(){
      this.setMultiselects();
      this.addListeners();
    }
  };

  //Instatntiate the class
  window.admin = new UELCAdmin();
  admin.init();

})
</script>
{% endblock %}